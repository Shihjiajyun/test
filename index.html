<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
</head>
<style>
    #reader {
        max-width: 300px;
        max-height: 300px;
        width: 80vw;
        height: 70vh;
    }

    #toggleCamera {
        position: fixed; /* 固定位置 */
        bottom: 20px;    /* 距離底部 20px */
        right: 20px;     /* 距離右側 20px */
        z-index: 999999; /* 保證按鈕在最上層 */
        background-color: #007bff; /* 背景顏色 */
        color: #fff;              /* 字體顏色 */
        border: none;             /* 無邊框 */
        border-radius: 50%;       /* 圓形按鈕 */
        width: 60px;              /* 按鈕寬度 */
        height: 60px;             /* 按鈕高度 */
        font-size: 18px;          /* 字體大小 */
        display: flex;            /* 居中對齊 */
        align-items: center;      /* 垂直居中 */
        justify-content: center;  /* 水平居中 */
        cursor: pointer;          /* 滑鼠樣式 */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* 陰影效果 */
    }

    #toggleCamera:hover {
        background-color: #0056b3; /* 滑鼠懸停時顏色 */
    }
</style>

<body>
    <h1>QR Code Scanner</h1>
    <div id="reader"></div>
    <p>Scan Result: <span id="result">None</span></p>
    <button id="toggleCamera">Flip Camera</button>

    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof Html5Qrcode === "undefined") {
                console.error("Html5Qrcode library not loaded. Check the CDN link or file path.");
                return;
            }

            const html5QrCode = new Html5Qrcode("reader");
            let isUsingFrontCamera = false; // 默認使用後置鏡頭
            let currentCameraId = null;

            function onScanSuccess(decodedText) {
                document.getElementById("result").innerText = "驗證中...";
                fetch(`php/verify.php?qr_code=${encodeURIComponent(decodedText)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`驗證成功！\n用戶 Email: ${data.user.email}\n報名時間: ${data.user.registration_time}`);
                        } else {
                            alert(`驗證失敗：${data.message}`);
                        }
                        location.reload();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("驗證失敗，請稍後再試。");
                        location.reload();
                    });

                html5QrCode.stop();
            }

            function onScanFailure(error) {
                console.warn(`QR Code scan failed. Error: ${error}`);
            }

            function startCamera(cameraId) {
                currentCameraId = cameraId;
                html5QrCode.start(
                    { deviceId: { exact: cameraId } },
                    {
                        fps: 10,
                        qrbox: {
                            width: 250,
                            height: 250
                        }
                    },
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    console.error("Error starting camera:", err);
                });
            }

            Html5Qrcode.getCameras()
                .then(cameras => {
                    if (cameras.length > 0) {
                        const backCamera = cameras.find(camera => camera.label.toLowerCase().includes("back"));
                        const frontCamera = cameras.find(camera => camera.label.toLowerCase().includes("front"));

                        // 預設啟動後置鏡頭
                        const initialCamera = backCamera || cameras[0];
                        startCamera(initialCamera.id);

                        document.getElementById("toggleCamera").addEventListener("click", () => {
                            html5QrCode.stop().then(() => {
                                isUsingFrontCamera = !isUsingFrontCamera;
                                const newCamera = isUsingFrontCamera ? (frontCamera || cameras[0]) : (backCamera || cameras[0]);
                                startCamera(newCamera.id);
                            }).catch(err => {
                                console.error("Error stopping camera:", err);
                            });
                        });
                    } else {
                        console.error("No cameras found.");
                    }
                })
                .catch(err => {
                    console.error("Error accessing cameras:", err);
                });
        });
    </script>

</body>

</html>
